resource "random_string" "random" {
  length  = 16
  special = false
  upper   = false
}

# #tfsec:ignore:*
# module "velero_backup_s3_bucket" {
#   source  = "terraform-aws-modules/s3-bucket/aws"
#   version = "~> 3.0"

#   bucket = "${local.name}-${random_string.random.result}"

#   # Allow deletion of non-empty bucket
#   # NOTE: This is enabled for example usage only, you should not enable this for production workloads
#   force_destroy = true

#   attach_deny_insecure_transport_policy = true
#   attach_require_latest_tls_policy      = true

#   acl = "private"

#   block_public_acls       = true
#   block_public_policy     = true
#   ignore_public_acls      = true
#   restrict_public_buckets = true

#   control_object_ownership = true
#   object_ownership         = "BucketOwnerPreferred"

#   versioning = {
#     status     = true
#     mfa_delete = false
#   }

#   server_side_encryption_configuration = {
#     rule = {
#       apply_server_side_encryption_by_default = {
#         sse_algorithm = "AES256"
#       }
#     }
#   }

#   tags = local.tags
# }

# resource "aws_efs_file_system" "efs" {
#   creation_token = "efs"
#   encrypted      = true

#   tags = local.tags
# }

# resource "aws_efs_mount_target" "efs_mt" {
#   count = length(module.aws_vpc.private_subnets)

#   file_system_id  = aws_efs_file_system.efs.id
#   subnet_id       = module.aws_vpc.private_subnets[count.index]
#   security_groups = [aws_security_group.efs.id]
# }

# resource "aws_security_group" "efs" {
#   name        = "${local.name}-efs"
#   description = "Allow inbound NFS traffic from private subnets of the VPC"
#   vpc_id      = data.terraform_remote_state.vpc.outputs.vpc_id

#   ingress {
#     description = "Allow NFS 2049/tcp"
#     cidr_blocks = data.terraform_remote_state.vpc.outputs.private_subnets_cidr_blocks
#     from_port   = 2049
#     to_port     = 2049
#     protocol    = "tcp"
#   }

#   tags = local.tags
# }

resource "kubernetes_storage_class" "storage_class" {
  metadata {
    name = "gp3"
  }

  storage_provisioner    = "ebs.csi.aws.com"
  allow_volume_expansion = true
  reclaim_policy         = "Delete"
  volume_binding_mode    = "WaitForFirstConsumer"
  parameters = {
    encrypted = true
    fsType    = "ext4"
    type      = "gp3"
  }
}